<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
	  	<!-- Declare the viewport to be the width of the device screen -->
	  	<meta name="viewport" content="width=device-width, initial-scale=1">
	  	<title>Chicago Bus and Train Tracker Display - CTA</title>
		<!-- Include Bootstrap library -->
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
		<!-- Include jQuery -->
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
		<!-- CSS Stylesheet -->
		<link rel="stylesheet" type="text/css" href="css/mystyle.css">
	</head>

	<body>
		<!-- All Content must be inside this Div (Container-Fluid) -->

		<div class="container-fluid">
			<!-- Row 0 - Header Row -->
			<div class="row lower-spacer">
				<!-- SPCA Logo -->
				<div class="col-lg-6 col-md-6 col-sm-6 splogo">
					<h1>SPCA Logo Placeholder</h1>
				</div>
				<!-- Show time via JS and justify right -->
				<div class="col-lg-6 col-md-6 col-sm-6">
					<h1 id="clockField" class="text-right"></h1>
				</div>
			</div>


			<!-- Row 1 - Bus and Train Names 1 -->
			<div class="row">
				<div class="col-lg-6 col-md-6 col-sm-6">
					<h1 class="text-center station-names left-padding">Sheridan and Rosemont [North]</h1>
				</div>
				<div class="col-lg-6 col-md-6 col-sm-6">
					<h1 class="text-center station-names">Loyola Station</h1>
				</div>
			</div>

			<!-- Row 2 - Bus and Train 1 Arrival Info 1 -->
			<div class="row left-padding">
				<div class="col-lg-6 col-md-6 col-sm-6">
					<div class="row bus-rows">
						<div class="col-lg-6 col-md-6 col-sm-6">
							<h1 id="busNameOne" class="bottom-margin">Bus 151</h1>
							<h3 id="busIDOne" class="top-margin">ID: 0515</h3>
						</div>
						<div class="col-lg-6 col-md-6 col-sm-6">
							<h1 id="busArrOne">2 MIN</h1>
						</div>
					</div>
				</div>
				<div class="col-lg-6 col-md-6 col-sm-6">
					<div class="row train-rows">
						<div class="col-lg-6 col-md-6 col-sm-6">
							<h1 id="trainNameOne" class="bottom-margin">Red Line</h1>
							<h3 id="trainIDOne" class="top-margin">Train # 1515</h3>
						</div>
						<div class="col-lg-6 col-md-6 col-sm-6">
							<h1 id="trainArrOne">5 MIN</h1>
						</div>
					</div>
				</div>
			</div>
		
			<!-- Row 3 - Bus and Train 1 Arrival Info 2 -->
			<div class="row left-padding">
				<div class="col-lg-6 col-md-6 col-sm-6">
					<div class="row bus-rows">
						<div class="col-lg-6 col-md-6 col-sm-6">
							<h1 id="busNameTwo" class="bottom-margin">Bus 161</h1>
							<h3 id="busIDTwo" class="top-margin">ID: 0212</h3>
						</div>
						<div class="col-lg-6 col-md-6 col-sm-6">
							<h1 id="busArrTwo">8 MIN</h1>
						</div>
					</div>
				</div>
				<div class="col-lg-6 col-md-6 col-sm-6">
					<div class="row train-rows">
						<div class="col-lg-6 col-md-6 col-sm-6">
							<h1 id="trainNameTwo" class="bottom-margin">Green Line</h1>
							<h3 id="trainIDTwo" class="top-margin">Train # 1215</h3>
						</div>
						<div class="col-lg-6 col-md-6 col-sm-6">
							<h1 id="trainArrTwo">12 MIN</h1>
						</div>
					</div>
				</div>
			</div>

			<!-- Row 4 - Bus and Train Names 2 -->
			<div class="row">
				<div class="col-lg-6 col-md-6 col-sm-6">
					<h1 class="text-center station-names left-padding">Sheridan and Rosemont [South]</h1>
				</div>
				<div class="col-lg-6 col-md-6 col-sm-6">
					<h1 class="text-center station-names">Granville Station</h1>
				</div>
			</div>

			<!-- Row 5 - Bus and Train 2 Arrival Info 1 -->
			<div class="row left-padding">
				<div class="col-lg-6 col-md-6 col-sm-6">
					<div class="row bus-rows">
						<div class="col-lg-6 col-md-6 col-sm-6">
							<h1 id="busNameThree" class="bottom-margin">Bus 225</h1>
							<h3 id="busIDThree" class="top-margin">ID: 9999</h3>
						</div>
						<div class="col-lg-6 col-md-6 col-sm-6">
							<h1 id="busArrThree">22 MIN</h1>
						</div>
					</div>
				</div>
				<div class="col-lg-6 col-md-6 col-sm-6">
					<div class="row train-rows">
						<div class="col-lg-6 col-md-6 col-sm-6">
							<h1 id="trainNameThree" class="bottom-margin">Yellow Line</h1>
							<h3 id="trainIDThree" class="top-margin">Train # 9150</h3>
						</div>
						<div class="col-lg-6 col-md-6 col-sm-6">
							<h1 id="trainArrThree">55 MIN</h1>
						</div>
					</div>
				</div>
			</div>
		
			<!-- Row 3 - Bus and Train 2 Arrival Info 2 -->
			<div class="row left-padding">
				<div class="col-lg-6 col-md-6 col-sm-6">
					<div class="row bus-rows">
						<div class="col-lg-6 col-md-6 col-sm-6">
							<h1 id="busNameFour" class="bottom-margin">Bus 520</h1>
							<h3 id="busIDFour" class="top-margin">ID: 5464</h3>
						</div>
						<div class="col-lg-6 col-md-6 col-sm-6">
							<h1 id="busArrFour">88 MIN</h1>
						</div>
					</div>
				</div>
				<div class="col-lg-6 col-md-6 col-sm-6">
					<div class="row train-rows">
						<div class="col-lg-6 col-md-6 col-sm-6">
							<h1 id="trainNameFour" class="bottom-margin">Blue Line</h1>
							<h3 id="trainIDFour" class="top-margin">Train # 612</h3>
						</div>
						<div class="col-lg-6 col-md-6 col-sm-6">
							<h1 id="trainArrFour">ARRIVING</h1>
						</div>
					</div>
				</div>
			</div>
			<div class="row upper-spacer">
				<div class="col-lg-6 col-md-6 col-sm-6">
						<img class="img-responsive center-block" src="images\ctaBusLogo.png" alt="CTA Logo" width="120px" height="120px">
				</div>
				<div class="col-lg-6 col-md-6 col-sm-6">	
						<img class="img-responsive center-block" src="images\ctaTrainLogo.png" alt="CTA Logo" width="120px" height="120px">
				</div>
			</div>
			<div class="row">
				<div class="col-lg-12">
					<h5 class="text-center">Data provided by the Chicago Transit Authority</h5>
				</div>
			</div>	
		</div>

		<script type="text/javascript">
			// Show time on screen (in ID clockField)
			var d = new Date();
			var t = d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
			document.getElementById("clockField").innerHTML=t;

			// jQuery Request to access and display CTA BUS API data (MUST use proxy!)
			// due to CORS restrictions.
			var busBaseURL = '/bustime/api/v2';
			var busRequestPredictions = '/getpredictions?';
			var busApiKey = 'key=' + '';
			var busStopIDNB = '&stpid=' + '1199';
			var busStopIDSB = '&stpid=' + '1032';
			var busFormat = '&format=' + 'json';
			var busPredictionURLNB = busBaseURL+busRequestPredictions+busApiKey+busStopIDNB+busFormat;
			var busPredictionURLSB = busBaseURL+busRequestPredictions+busApiKey+busStopIDSB+busFormat;

			$(document).ready(function(){
				$.getJSON(busPredictionURLNB, function(data){
					if (data["bustime-response"].hasOwnProperty("error")) {
						console.log("BR has error " + data["bustime-response"].error[0].msg);
						$("#busNameOne").html('No Rts Scheduled');
						$("#busIDOne").html('&zwnj;');
						$("#busArrOne").html('&zwnj;');
						$("#busNameTwo").html('&zwnj;');
						$("#busIDTwo").html('&zwnj;');
						$("#busArrTwo").html('&zwnj;');
					}
					else if (data["bustime-response"].hasOwnProperty("prd")) {
						if (data["bustime-response"].prd.length > 1) {
							console.log("Length of BR is greater than 1!");
							console.log(data["bustime-response"].prd.length);
							var busName1 = data["bustime-response"].prd[0].rt;
							var busID1 = 'Bus # ' + data["bustime-response"].prd[0].vid;
							if (data["bustime-response"].prd[0].prdctdn === "DUE") {
								var busArr1 = "ARRIVING";
							}
							else if (data["bustime-response"].prd[0].prdctdn === "DLY") {
								var busArr1 = "DELAYED";
							}
							else {
								var busArr1 = data["bustime-response"].prd[0].prdctdn + ' MIN';
							}
							var busName2 = data["bustime-response"].prd[1].rt;
							var busID2 = 'Bus # ' + data["bustime-response"].prd[1].vid;
							if (data["bustime-response"].prd[1].prdctdn === "DUE") {
								var busArr2 = "ARRIVING";
							}
							else if (data["bustime-response"].prd[1].prdctdn === "DLY") {
								var busArr2 = "DELAYED";
							}
							else {
								var busArr2 = data["bustime-response"].prd[1].prdctdn + ' MIN';
							}

							$("#busNameOne").html(busName1);
							$("#busIDOne").html(busID1);
							$("#busArrOne").html(busArr1);
							$("#busNameTwo").html(busName2);
							$("#busIDTwo").html(busID2);
							$("#busArrTwo").html(busArr2);
						}
						else if (data["bustime-response"].prd.length == 1) {
							console.log("Length of BR is exactly one!");
							console.log(data["bustime-response"].prd.length);
							var busName1 = data["bustime-response"].prd[0].rt;
							var busID1 = 'Bus # ' + data["bustime-response"].prd[0].vid;
							if (data["bustime-response"].prd[0].prdctdn === "DUE") {
								var busArr1 = "ARRIVING";
							}
							else if (data["bustime-response"].prd[0].prdctdn === "DLY") {
								var busArr1 = "DELAYED";
							}
							else {
								var busArr1 = data["bustime-response"].prd[0].prdctdn + ' MIN';
							}
							var busName2 = '&zwnj;'
							var busID2 = '&zwnj;'
							var busArr2 = '&zwnj;'

							$("#busNameOne").html(busName1);
							$("#busIDOne").html(busID1);
							$("#busArrOne").html(busArr1);
							$("#busNameTwo").html(busName2);
							$("#busIDTwo").html(busID2);
							$("#busArrTwo").html(busArr2);
						}
						else {
							console.log("Uh... Length is neither greater nor equal to 1!");
							console.log(data["bustime-response"].prd.length);
						}
					}
					else {
						console.log("Uh.... neither Prd nor Err!");
					}

				});
				$.getJSON(busPredictionURLSB, function(data){
					if (data["bustime-response"].hasOwnProperty("error")) {
						console.log("BR has error " + data["bustime-response"].error[0].msg);
						$("#busNameThree").html('No Rts Scheduled');
						$("#busIDThree").html('&zwnj;');
						$("#busArrThree").html('&zwnj;');
						$("#busNameFour").html('&zwnj;');
						$("#busIDFour").html('&zwnj;');
						$("#busArrFour").html('&zwnj;');
					}
					else if (data["bustime-response"].hasOwnProperty("prd")) {
						if (data["bustime-response"].prd.length > 1) {
							console.log("Length of BR is greater than 1!");
							console.log(data["bustime-response"].prd.length);
							var busName3 = data["bustime-response"].prd[0].rt;
							var busID3 = 'Bus # ' + data["bustime-response"].prd[0].vid;
							if (data["bustime-response"].prd[0].prdctdn == "DUE") {
								var busArr3 = "ARRIVING";
							}
							else if (data["bustime-response"].prd[0].prdctdn === "DLY") {
								var busArr3 = "DELAYED";
							}
							else {
								var busArr3 = data["bustime-response"].prd[0].prdctdn + ' MIN';
							}
							var busName4 = data["bustime-response"].prd[1].rt;
							var busID4 = 'Bus # ' + data["bustime-response"].prd[1].vid;
							if (data["bustime-response"].prd[1].prdctdn == "DUE") {
								var busArr4 = "ARRIVING";
							}
							else if (data["bustime-response"].prd[1].prdctdn === "DLY") {
								var busArr4 = "DELAYED";
							}
							else {
								var busArr4 = data["bustime-response"].prd[1].prdctdn + ' MIN';
							}

							$("#busNameThree").html(busName3);
							$("#busIDThree").html(busID3);
							$("#busArrThree").html(busArr3);
							$("#busNameFour").html(busName4);
							$("#busIDFour").html(busID4);
							$("#busArrFour").html(busArr4);
						}
						else if (data["bustime-response"].prd.length == 1) {
							console.log("Length of BR is exactly one!");
							console.log(data["bustime-response"].prd.length);
							var busName3 = data["bustime-response"].prd[0].rt;
							var busID3 = 'Bus # ' + data["bustime-response"].prd[0].vid;
							if (data["bustime-response"].prd[0].prdctdn == "DUE") {
								var busArr3 = "ARRIVING";
							}
							else if (data["bustime-response"].prd[0].prdctdn === "DLY") {
								var busArr3 = "DELAYED";
							}
							else {
								var busArr3 = data["bustime-response"].prd[0].prdctdn + ' MIN';
							}
							var busName4 = '&zwnj;'
							var busID4 = '&zwnj;'
							var busArr4 = '&zwnj;'

							$("#busNameThree").html(busName3);
							$("#busIDThree").html(busID3);
							$("#busArrThree").html(busArr3);
							$("#busNameFour").html(busName4);
							$("#busIDFour").html(busID4);
							$("#busArrFour").html(busArr4);
						}
						else {
							console.log("Uh... Length is neither greater nor equal to 1!");
							console.log(data["bustime-response"].prd.length);
						}
					}
					else {
						console.log("Uh.... neither Prd nor Err!");
					}
				});

				console.log("GOT HERE! LINE 347")
				var trainApiKey = '';
				var mapID = '41300';
				var granMapID = '40760';
				var trainUrl = '/api/1.0/ttarrivals.aspx?key=' + trainApiKey + '&mapid=' + mapID + '&outputType=json';
				var granTrainUrl = '/api/1.0/ttarrivals.aspx?key=' + trainApiKey + '&mapid=' + granMapID + '&outputType=json';

				function timeDiff(a, b) {
					var c = new Date(a);
					var d = new Date(b);
					return Math.abs((c-d)/1000/60);
					}				
				
				function removeService(a) {
					var c = a.split("Service ");
					return c;
				}

				$.getJSON(trainUrl, function(data){
					console.log(data["ctatt"].eta.length);
					if (data["ctatt"].errCd == 0) {
						if (data["ctatt"].eta.length < 1) {
							console.log("ERROR: The length of ETA Array is < 1" + (data["ctatt"].eta.length));
						}
						else if (data["ctatt"].eta.length == 1) {
							if (data["ctatt"].eta[0].isApp == 1) {
								trainName1 = data["ctatt"].eta[0].rt;
								trainID1 = removeService(data["ctatt"].eta[0].stpDe);
								$("#trainNameOne").html(trainName1 + ' Line');
								$("#trainIDOne").html(trainID1);
								$("#trainArrOne").html('ARRIVING');
								$("#trainNameTwo").html('&zwnj;');
								$("#trainIDTwo").html('&zwnj;');
								$("#trainArrTwo").html('&zwnj;');
							}
							else if (data["ctatt"].eta[0].isDly == 1) {
								trainName1 = data["ctatt"].eta[0].rt;
								trainID1 = data["ctatt"].eta[0].stpDe;
								$("#trainNameOne").html(trainName1 + ' Line');
								$("#trainIDOne").html(trainID1);
								$("#trainArrOne").html('DELAYED');
								$("#trainNameTwo").html('&zwnj;');
								$("#trainIDTwo").html('&zwnj;');
								$("#trainArrTwo").html('&zwnj;');
							}
							else {
								console.log("Length of CTA Array is one")
								trainName1 = data["ctatt"].eta[0].rt;
								trainID1 = data["ctatt"].eta[0].stpDe;
								trainArr1 = timeDiff((data["ctatt"].eta[0].prdt), (data["ctatt"].eta[0].arrT));
								$("#trainNameOne").html(trainName1 + ' Line');
								$("#trainIDOne").html(trainID1);
								$("#trainArrOne").html(trainArr1 + ' MIN');
								$("#trainNameTwo").html('&zwnj;');
								$("#trainIDTwo").html('&zwnj;');
								$("#trainArrTwo").html('&zwnj;');
							}
						}
						else if (data["ctatt"].eta.length > 1) {
							console.log("I am greater than 1, at line 400!");
							trainName1 = data["ctatt"].eta[0].rt;
							trainID1 = removeService(data["ctatt"].eta[0].stpDe);
							trainName2 = trainName1 = data["ctatt"].eta[1].rt;
							trainID2 = removeService(data["ctatt"].eta[1].stpDe);

							$("#trainNameOne").html(trainName1 + ' Line');
							$("#trainIDOne").html(trainID1);
							$("#trainNameTwo").html(trainName2 + ' Line');
							$("#trainIDTwo").html(trainID2);

							if ((data["ctatt"].eta[0].isApp) && (data["ctatt"].eta[0].isDly) == 0){
								trainArr1 = timeDiff((data["ctatt"].eta[0].prdt), (data["ctatt"].eta[0].arrT));
								console.log("Line 413, " + trainArr1);
								$("#trainArrOne").html(trainArr1 + ' MIN');

							}
							else if (data["ctatt"].eta[0].isApp == 1) {
								$("#trainArrOne").html('ARRIVING');
							}
							else if (data["ctatt"].eta[0].isDly == 1) {
								$("#trainArrOne").html('DELAYED');
							}

							if ((data["ctatt"].eta[1].isApp) && (data["ctatt"].eta[1].isDly) == 0){
								trainArr2 = timeDiff((data["ctatt"].eta[1].prdt), (data["ctatt"].eta[1].arrT));
								$("#trainArrTwo").html(trainArr2 + ' MIN');

							}
							else if (data["ctatt"].eta[1].isApp == 1) {
								$("#trainArrTwo").html('ARRIVING');
							}
							else if (data["ctatt"].eta[1].isDly == 1) {
								$("#trainArrTwo").html('DELAYED');
							}

						}
					}
					else {
						console.log("THE ERROR IS HERE!");
					}

 				});

 				$.getJSON(granTrainUrl, function(data){
					console.log(data["ctatt"].eta.length);
					if (data["ctatt"].errCd == 0) {
						if (data["ctatt"].eta.length < 1) {
							console.log("ERROR: The length of ETA Array is < 1" + (data["ctatt"].eta.length));
						}
						else if (data["ctatt"].eta.length == 1) {
							if (data["ctatt"].eta[0].isApp == 1) {
								trainName3 = data["ctatt"].eta[0].rt;
								trainID3 = data["ctatt"].eta[0].stpDe;
								$("#trainNameThree").html(trainName3 + ' Line');
								$("#trainIDThree").html(trainID3);
								$("#trainArrThree").html('ARRIVING');
								$("#trainNameFour").html('&zwnj;');
								$("#trainIDFour").html('&zwnj;');
								$("#trainArrFour").html('&zwnj;');							
							}
							else if (data["ctatt"].eta[0].isDly == 1) {
								trainName3 = data["ctatt"].eta[0].rt;
								trainID3 = data["ctatt"].eta[0].stpDe;
								$("#trainNameThree").html(trainName3 + ' Line');
								$("#trainIDThree").html(trainID3);
								$("#trainArrThree").html('DELAYED');
								$("#trainNameFour").html('&zwnj;');
								$("#trainIDFour").html('&zwnj;');
								$("#trainArrFour").html('&zwnj;');
							}
							else {
								console.log("Length of CTA Array is one")
								trainName3 = data["ctatt"].eta[0].rt;
								trainID3 = data["ctatt"].eta[0].stpDe;
								trainArr3 = timeDiff((data["ctatt"].eta[0].prdt), (data["ctatt"].eta[0].arrT));
								$("#trainNameThree").html(trainName3 + ' Line');
								$("#trainIDThree").html(trainID1);
								$("#trainArrThree").html(trainArr1 + ' MIN');
								$("#trainNameFour").html('&zwnj;');
								$("#trainIDFour").html('&zwnj;');
								$("#trainArrFour").html('&zwnj;');
							}
						}
						else if (data["ctatt"].eta.length > 1) {
							console.log("I am greater than 1, at line 400!");
							trainName3 = data["ctatt"].eta[0].rt;
							trainID3 = removeService(data["ctatt"].eta[0].stpDe);
							trainName4 = trainName1 = data["ctatt"].eta[1].rt;
							trainID4 = removeService(data["ctatt"].eta[1].stpDe);

							$("#trainNameThree").html(trainName3 + ' Line');
							$("#trainIDThree").html(trainID3);
							$("#trainNameFour").html(trainName4 + ' Line');
							$("#trainIDFour").html(trainID4);

							if ((data["ctatt"].eta[0].isApp) && (data["ctatt"].eta[0].isDly) == 0){
								trainArr3 = timeDiff((data["ctatt"].eta[0].prdt), (data["ctatt"].eta[0].arrT));
								console.log("Line 413, " + trainArr3);
								$("#trainArrThree").html(trainArr3 + ' MIN');

							}
							else if (data["ctatt"].eta[0].isApp == 1) {
								$("#trainArrThree").html('ARRIVING');
							}
							else if (data["ctatt"].eta[0].isDly == 1) {
								$("#trainArrThree").html('DELAYED');
							}

							if ((data["ctatt"].eta[1].isApp) && (data["ctatt"].eta[1].isDly) == 0){
								trainArr4 = timeDiff((data["ctatt"].eta[1].prdt), (data["ctatt"].eta[1].arrT));
								$("#trainArrFour").html(trainArr4 + ' MIN');

							}
							else if (data["ctatt"].eta[1].isApp == 1) {
								$("#trainArrFour").html('ARRIVING');
							}
							else if (data["ctatt"].eta[1].isDly == 1) {
								$("#trainArrFour").html('DELAYED');
							}

						}
					}
					else {
						console.log("THE ERROR IS HERE!");
					}

 				});
				
			});

		</script>
	</body>
</html>
